# Maintainer: xsy420 <xsy0420@gmail.com>
# Contributor: AlphaJack <alphajack at tuta dot io>
# Contributor: George Rawlinson <grawlinson@archlinux.org>

pkgbase="duckdb"
pkgname=("duckdb" "python-duckdb")
pkgver=1.4.3
pkgrel=2
pkgdesc="An in-process SQL OLAP database management system"
arch=("x86_64")
url="https://duckdb.org"
license=("MIT")
depends=(
    "gcc-libs"
    "openssl"
)
makedepends=(
    "git"
    "cmake"
    "uv"
    "pybind11"
    "python-installer"
    "python-setuptools-scm"
    "python-scikit-build-core"
)
conflicts=("duckdb-bin" "duckdb-git")
source=(
    "git+https://github.com/duckdb/duckdb.git#tag=v$pkgver"
    "python-duckdb::git+https://github.com/duckdb/duckdb-python.git#tag=v$pkgver"
)
b2sums=('5e07b30dd57240e521ff849eb03adf655a3791beba77ea3eefba010cdf95b227ac79f05895920bf7146b2f8d52a62ea7966e7af3d1dc8c6319d5c025f80158dd'
        'bb075924166283fd591c7df089e288014986804527e1ecedd712baf7384df41640905e6d8f146ec443c4382cd32bdf13503326005835b1469b8e66f23fe5f168')

prepare() {
    cmake \
        -S "$pkgbase" \
        -B "$pkgbase"-build \
        -D CMAKE_BUILD_TYPE=Release \
        -D CMAKE_INSTALL_PREFIX=/usr \
        -D OVERRIDE_GIT_DESCRIBE="v${pkgver}"
    cd "$srcdir/python-${pkgbase}"
    git submodule init
    git config submodule.external/duckdb.url "$srcdir/$pkgbase"
    git -c protocol.file.allow=always submodule update
}

build() {
    cmake --build "$pkgbase"-build
    SKBUILD_BUILD_DIR="${srcdir}/python-$pkgbase-build" uv build --wheel --directory="${srcdir}/python-${pkgbase}/" --no-build-isolation --cache-dir "${srcdir}/uv-cache/" --no-create-gitignore
}

package_duckdb() {
    DESTDIR="$pkgdir" cmake --install "$pkgname"-build

    # sqlite wrapper
    install -vDm755 -t "$pkgdir/usr/lib" "$pkgname"-build/tools/sqlite3_api_wrapper/libsqlite3_api_wrapper.so

    # license
    install -vDm644 -t "$pkgdir/usr/share/licenses/$pkgname" "$pkgname/LICENSE"
}

package_python-duckdb() {
    pkgdesc+=" (Python API)"
    depends=(
        "python"
        "gcc-libs"
    )
    optdepends=(
        "ipython: used in duckdb.query_graph"
        "python-fsspec: used in duckdb.filesystem"
        "python-numpy: used in duckdb.experimental.spark and in duckdb.fetchnumpy()"
        "python-pandas: used for pandas dataframes all over the place"
        "python-pyarrow: used for pyarrow support"
        "python-arrow-adbc: for the adbc driver"
    )
    conflicts=("python-duckdb-git")

    # library
    python -m installer --destdir="${pkgdir}" "${srcdir}/${pkgname}/dist/"*.whl

    # license
    install -vDm644 -t "$pkgdir/usr/share/licenses/$pkgname" "$pkgname/LICENSE"
}
